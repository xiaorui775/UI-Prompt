name: Track Template Updates

# è§¸ç™¼æ¢ä»¶ï¼š
# 1. Push åˆ° main åˆ†æ”¯ä¸”åŒ…å«æ¨¡æ¿æ–‡ä»¶è®Šæ›´
# 2. æ‰‹å‹•è§¸ç™¼ï¼ˆworkflow_dispatchï¼‰
on:
  push:
    branches: ["main"]
    paths:
      - 'src/data/styles/templates/**/*.js'
      - 'src/data/styles/templates/**/*.jsx'
      - 'src/data/components/**/*.js'
      - 'src/data/components/**/*.jsx'
  workflow_dispatch:
    inputs:
      force_full_scan:
        description: 'Force full scan of all templates'
        required: false
        type: boolean
        default: false

jobs:
  track-updates:
    name: Track Template Updates
    runs-on: ubuntu-latest

    permissions:
      contents: write  # éœ€è¦å¯«å…¥æ¬Šé™ä»¥æäº¤å…ƒæ•¸æ“šè®Šæ›´

    steps:
      # Step 1: Checkout ä»£ç¢¼ï¼ˆç²å–å®Œæ•´æ­·å²ï¼‰
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ç²å–å®Œæ•´ Git æ­·å²ä»¥åˆ†æè®Šæ›´
          token: ${{ secrets.GITHUB_TOKEN }}

      # Step 2: Setup Node.js ç’°å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # Step 3: å®‰è£ä¾è³´ï¼ˆåƒ…å®‰è£ç”Ÿç”¢ä¾è³´ä»¥åŠ å¿«é€Ÿåº¦ï¼‰
      - name: Install dependencies
        run: npm ci --only=production || npm install --only=production

      # Step 4: æª¢æ¸¬è®Šæ›´çš„æ–‡ä»¶
      - name: Detect changed templates
        id: detect
        run: |
          echo "Detecting template changes..."

          # ç²å–è®Šæ›´çš„æ–‡ä»¶åˆ—è¡¨
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E "src/data/(styles/templates|components)/.*\.(js|jsx)$" || echo "")

          if [ -z "$CHANGED_FILES" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No template changes detected."
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changed files:"
            echo "$CHANGED_FILES"
          fi

      # Step 5: é‹è¡Œè¿½è¹¤è…³æœ¬
      - name: Track updates
        if: steps.detect.outputs.changed == 'true' || github.event.inputs.force_full_scan == 'true'
        run: |
          echo "Running track-updates.js..."
          node scripts/track-updates.js

      # Step 6: ç”Ÿæˆå®Œæ•´å…ƒæ•¸æ“š
      - name: Generate metadata
        if: steps.detect.outputs.changed == 'true' || github.event.inputs.force_full_scan == 'true'
        run: |
          echo "Running generate-metadata.js..."

          if [ "${{ github.event.inputs.force_full_scan }}" = "true" ]; then
            node scripts/generate-metadata.js --full
          else
            node scripts/generate-metadata.js
          fi

      # Step 7: æª¢æŸ¥æ˜¯å¦æœ‰å…ƒæ•¸æ“šè®Šæ›´
      - name: Check for metadata changes
        id: check_changes
        if: steps.detect.outputs.changed == 'true' || github.event.inputs.force_full_scan == 'true'
        run: |
          if git diff --quiet src/data/metadata/templateMetadata.json; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No metadata changes detected."
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Metadata has been updated."

            # é¡¯ç¤ºè®Šæ›´æ‘˜è¦
            echo "Changes:"
            git diff --stat src/data/metadata/templateMetadata.json
          fi

      # Step 8: æäº¤å…ƒæ•¸æ“šè®Šæ›´
      - name: Commit metadata changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add src/data/metadata/templateMetadata.json

          # ä½¿ç”¨ Heredoc å‰µå»º commit è¨Šæ¯
          git commit -F - <<EOF
          chore: update template metadata [skip ci]

          Automated metadata update triggered by template changes.

          Changes detected in:
          $(git diff --cached --name-only --diff-filter=M | head -5)

          This commit is automatically generated by the track-template-updates workflow.
          EOF

          echo "Metadata committed successfully."

      # Step 9: Push è®Šæ›´å› repository
      - name: Push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git push origin main
          echo "Changes pushed to main branch."

      # Step 10: ç”Ÿæˆæ‘˜è¦å ±å‘Š
      - name: Generate summary
        if: always()
        run: |
          echo "## ğŸ“Š Template Update Tracking Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.detect.outputs.changed }}" = "true" ] || [ "${{ github.event.inputs.force_full_scan }}" = "true" ]; then
            if [ -f "src/data/metadata/templateMetadata.json" ]; then
              # è®€å–å…ƒæ•¸æ“šçµ±è¨ˆ
              TOTAL=$(jq -r '.totalTemplates // 0' src/data/metadata/templateMetadata.json)
              NEW=$(jq -r '.newTemplates // 0' src/data/metadata/templateMetadata.json)
              UPDATED=$(jq -r '.updatedTemplates // 0' src/data/metadata/templateMetadata.json)
              LAST_UPDATE=$(jq -r '.lastUpdate // "N/A"' src/data/metadata/templateMetadata.json)

              echo "âœ… Metadata updated successfully!" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
              echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
              echo "| Total Templates | $TOTAL |" >> $GITHUB_STEP_SUMMARY
              echo "| New Templates (â‰¤7 days) | $NEW |" >> $GITHUB_STEP_SUMMARY
              echo "| Updated Templates | $UPDATED |" >> $GITHUB_STEP_SUMMARY
              echo "| Last Update | $LAST_UPDATE |" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY

              if [ "${{ steps.check_changes.outputs.has_changes }}" = "true" ]; then
                echo "ğŸ”„ Metadata file was updated and committed." >> $GITHUB_STEP_SUMMARY
              else
                echo "â„¹ï¸  No changes to metadata file." >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "âš ï¸  Metadata file not found!" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â„¹ï¸  No template changes detected. Workflow skipped." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "Workflow run at: $(date -u)" >> $GITHUB_STEP_SUMMARY
